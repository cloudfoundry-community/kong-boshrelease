#!/bin/bash

set -e # exit immediately if a simple command exits with a non-zero status
set -u # report the usage of uninitialized variables

# Setup env vars and folders for the webapp_ctl script
source /var/vcap/jobs/kong/helpers/ctl_setup.sh 'kong'

export DOCKER_COMMAND="/var/vcap/packages/docker/bin/docker -H unix:///var/vcap/sys/run/docker/docker.sock"
export container_name="kong"
export CONTAINERS_PID_DIR=${RUN_DIR}
export CONTAINER_PID_FILE=${CONTAINERS_PID_DIR}/${container_name}.pid
export DOCKER_IMAGE="avinetworks/controller:17.1.9-9014-20171007.024036"

case $1 in

  start)
    pid_guard ${CONTAINER_PID_FILE} ${JOB_NAME}
    echo $$ > ${CONTAINER_PID_FILE}

    ${DOCKER_COMMAND} stop ${container_name}
    ${DOCKER_COMMAND} rm ${container_name} -f

    ${DOCKER_COMMAND} run --name=${container_name} -p 5098:5098 -p 8443:8443 \
       -p 5054:5054 -p 80:80 -p 443:443 -p 161:161/udp  -d --privileged \
       -e "CONTAINER_NAME=kong" -e "MANAGEMENT_IP=<%= p('management_ip') %>" \
       -e NUM_CPU=4 -e NUM_MEMG=15  -e DISK_GB=30 -e CNTRL_SSH_PORT=5098 \
       -e SYSINT_PORT=8443 -e HTTP_PORT=80 -e HTTPS_PORT=443 -v /:/hostroot/ \
       -v /var/vcap/sys/run/docker/docker.sock:/var/run/docker.sock  -v /var/vcap/store/kong:/vol/ \
       ${DOCKER_IMAGE} \
       >>${LOG_DIR}/${output_label}.stdout.log \
       2>>${LOG_DIR}/${output_label}.stderr.log

    pid_process=$(${DOCKER_COMMAND} inspect -f '{{ .State.Pid }}' ${container_name})
    echo $pid_process > ${CONTAINER_PID_FILE}
    ;;

  stop)
    ${DOCKER_COMMAND} stop ${container_name}
    ${DOCKER_COMMAND} rm ${container_name} -f
    ;;
  *)
    echo "Usage: ctl {start|stop}"

    ;;

esac
exit 0
