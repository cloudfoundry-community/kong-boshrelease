#!/bin/bash
export KONG_ADMIN_ADDRESS=10.244.20.2:8001
export KONG_ADMIN_RESPONSE=$(curl $KONG_ADMIN_ADDRESS/apis/)
export NUM_OF_MAPPINGS=$(echo $KONG_ADMIN_RESPONSE | jq '.[0] | .total')

<%
#bootstrapped config
configlist = []
config.each do |config|
  config_name = config['name']
  config_hosts = config['hosts'] || ''
  config_uris = config['uris'] || ''
  config_upstream_url = config['upstream_url'] || ''
  configlist.push(config_name + '|' + config_hosts + '|' + config_uris + '|' + config_upstream_url)
end
config[] = configlist
%>

#delete existing kong mappings
for i in `seq 0 $NUM_OF_MAPPINGS`;
  do
    echo "deleting mapping number: $i"
    API_ID=$(echo $KONG_ADMIN_RESPONSE | jq '. | .data[$i].id')
    curl DELETE \
      --url $KONG_ADMIN_ADDRESS/apis/$API_ID
done

#send the new mappings to the kong admin
for j in `seq 0 $NUM_OF_MAPPINGS`
  do
    <% if_p("config.hosts") do |hosts| %>
      echo "sending mapping with hosts: $hosts"
      curl POST \
        --url $KONG_ADMIN_ADDRESS/apis/ \
        --data "name=$config.config_name[$j]" \
        --data 'hosts=$hosts' \
        --data 'upstream_url=$config._upstream_url'
    <% end %>

    <% if_p("config.uris") do |uris| %>
      echo "sending mapping with uris: $uris"
      curl POST \
        --url $KONG_ADMIN_ADDRESS/apis/ \
        --data "name=$config.config_name[$j]" \
        --data 'uris=$uris' \
        --data 'upstream_url=$config.upstream_url'
    <% end %>
done
exit 0